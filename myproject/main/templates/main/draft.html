{% load static %}
{% load scene_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 2 - Draft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'main/css/style.css' %}">
</head>
<body class="bg-light">
    <nav class="d-flex justify-content-center py-4 bg-white">
        <a href="{% url 'idea' %}" class="step completed">
            <div>1</div>
            <small>Idea</small>
        </a>
        <div class="step active">
            <div>2</div>
            <small>Draft</small>
        </div>
        <a href="{% url 'personas' %}" class="step completed">
            <div>3</div>
            <small>Personas</small>
        </a>
        <a href="{% url 'locations' %}" class="step completed">
            <div>4</div>
            <small>Locations</small>
        </a>
        <a href="{% url 'scene' %}" class="step completed">
            <div>5</div>
            <small>Scenes</small>
        </a>
        <a href="{% url 'video' %}" class="step completed">
            <div>6</div>
            <small>Video</small>
        </a>
    </nav>
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
            <p class="text-white mt-3" style="font-size: 1.5rem;">Generating...</p>
        </div>
    </div>
    <div class="container mt-5">
        <h2 class="mb-2 text-center">Draft</h2>

        <br>
        
        <div class="card shadow-sm mx-auto p-4" style="max-width: 700px;">
            <!-- Draft Display Box -->
            <div class="border rounded p-3 bg-white mb-4">
                
                <h5 class="fw-bold mb-3"></h5>
                <h6 class="text-secondary mb-0 me-2">Storyline:</h6>
                <p class="text-secondary mb-4">This is the storyline used to generate your story. Make any changes to the overall story or what characters and locations should be included here. These emotional tones appear throughout the story.</p>

                <div class="d-flex align-items-center mb-3">
                    <h6 class="text-secondary mb-0 me-2">Tones:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tone in draft.emotional_tones %}
                            <span class="badge bg-secondary">{{ tone }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="p-3 bg-light rounded">
                    <p class="mb-2" name="overview">{{ draft.storyline|linkify_characters_and_locations:story_data }}</p>
                </div>
            </div>

            <!-- Feedback Form -->
            <form method="post" action="{% url 'draft' %}" id="locationForm">
                {% csrf_token %}
                <input type="hidden" name="location_id" id="locationId" value="1">
                
                <div class="position-relative mb-4">
                    <textarea 
                        class="form-control" 
                        name="feedback" 
                        id="feedbackText"
                        rows="4" 
                        placeholder="Do you want to make any changes?"
                    ></textarea>
                    <button 
                        type="submit" 
                        name="action" 
                        value="regenerate" 
                        class="btn btn-link position-absolute top-0 end-0 mt-2 me-2"
                        style="font-size: 1.5rem; color: #6c757d;"
                    >
                        <i class="bi bi-rocket-takeoff icon-button"></i>

                    </button>
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="submit" name="action" value="next" class="btn btn-primary">Next â†’</button>
                </div>
            </form>
        
        </div>
    </div>
    <script>
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                // Check if this is a generation action
                const action = form.querySelector('[name="action"]')?.value;
                if (action && (action.includes('generate') || action.includes('regenerate'))) {
                    document.getElementById('loadingOverlay').style.display = 'block';
                }
            });
        });
    </script>
</body>
</html>