{% load static %}
{% load scene_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 2 - Draft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'main/css/style.css' %}">
</head>
<body class="bg-light">
    <nav class="story-nav">
        <div class="nav-container">
            <!-- Left: Start Over -->
            <a href="{% url 'idea' %}" class="nav-btn nav-start">
                <i class="bi bi-arrow-counterclockwise"></i>
                Start Over
            </a>
            
            <!-- Center: 4 editing steps -->
            <div class="nav-center">
                <div class="nav-step active">
                    <i class="bi bi-book"></i>
                    Storyline
                </div>
                <a href="{% url 'personas' %}" class="nav-step completed">
                    <i class="bi bi-person"></i>
                    Personas
                </a>
                <a href="{% url 'locations' %}" class="nav-step completed">
                    <i class="bi bi-house"></i>
                    Locations
                </a>
                <a href="{% url 'scene' %}" class="nav-step completed">
                    <i class="bi bi-camera"></i>
                    Scenes
                </a>
            </div>
            
            <!-- Right: Storyboard -->
            <a href="{% url 'video' %}" class="nav-btn nav-storyboard">
                <i class="bi bi-film"></i>
                Storyboard
            </a>
        </div>
    </nav>
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <div class="rocket-orbit">
                <i class="bi bi-rocket-takeoff rocket-icon"></i>
            </div>
            <p class="text-white mt-5" style="font-size: 1.5rem;">Regenerating your story...</p>
        </div>
    </div>
    
    <div class="container mt-5">
        <h2 class="mb-2 text-center">Storyline</h2>

        <br>
        
        <div class="card shadow-sm mx-auto p-4" style="max-width: 700px;">
            <!-- Draft Display Box -->
            <div class="border rounded p-3 bg-white mb-4">
                
                <h5 class="fw-bold mb-3"></h5>
                <h6 class="text-secondary mb-0 me-2">Storyline:</h6>
                <p class="text-secondary mb-4">This is the storyline used to generate your story. Make any changes to the overall story or what characters and locations should be included here. These emotional tones appear throughout the story.</p>

                <div class="d-flex align-items-center mb-3">
                    <h6 class="text-secondary mb-0 me-2">Tones:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tone in draft.emotional_tones %}
                            <span class="badge bg-secondary">{{ tone }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="p-3 bg-light rounded">
                    <p class="mb-2" name="overview">{{ draft.storyline|linkify_characters_and_locations:story_data }}</p>
                </div>
            </div>

            <!-- Feedback Form -->
            <form method="post" action="{% url 'draft' %}" id="locationForm">
                {% csrf_token %}
                <input type="hidden" name="location_id" id="locationId" value="1">
                
                <div class="position-relative mb-4">
                    <textarea 
                        class="form-control" 
                        name="feedback" 
                        id="feedbackText"
                        rows="4" 
                        placeholder="Do you want to make any changes?"
                    ></textarea>
                    <button 
                        type="submit" 
                        name="action" 
                        value="regenerate" 
                        class="btn btn-link position-absolute top-0 end-0 mt-2 me-2"
                        style="font-size: 1.5rem; color: #6c757d;"
                    >
                        <i class="bi bi-rocket-takeoff icon-button"></i>

                    </button>
                </div>
            </form>
        
        </div>
    </div>
    <script>
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const action = form.querySelector('[name="action"]')?.value;
                if (action && (action.includes('generate') || action.includes('regenerate') || action === 'next')) {
                    document.getElementById('loadingOverlay').style.display = 'block';
                }
            });
        });
    </script>
</body>
</html>